stages:
  - integration
  - merge_request
  - feature

.print_vars:
  stage: integration
  script:
    - echo "$CI_COMMIT_BRANCH"
    - echo "$CI_COMMIT_REF_NAME"
    - echo "$CI_DEFAULT_BRANCH"
    - echo "$CI_OPEN_MERGE_REQUESTS"
    - echo "$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
    - echo "$CI_MERGE_REQUEST_SOURCE_BRANCH_PROTECTED"
    - echo "$CI_MERGE_REQUEST_SOURCE_BRANCH_SHA"
    - echo "$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"
    - echo "$CI_MERGE_REQUEST_TARGET_BRANCH_PROTECTED"
    - echo "$CI_MERGE_REQUEST_TARGET_BRANCH_SHA"
    - echo "$CI_EXTERNAL_PULL_REQUEST_SOURCE_BRANCH_NAME"
    - echo "$CI_EXTERNAL_PULL_REQUEST_SOURCE_BRANCH_SHA"
    - echo "$CI_EXTERNAL_PULL_REQUEST_TARGET_BRANCH_NAME"
    - echo "$CI_EXTERNAL_PULL_REQUEST_TARGET_BRANCH_SHA"
    - echo "GitLab CI/CD | Print all environment variables"
    - env

# AGIFY
micro_agify_develop:
  stage: integration
  variables:
    MICRO_PATH: "micro_agify"
    DOCKER_IMAGE_NAME: "f64franco/micro-agify"
  trigger:
    include: CI_CD/.develop-pipeline.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BRANCH == $DEVELOP_BRANCH_NAME
      changes:
        - micro_agify/**/*

micro_agify_main:
  stage: integration
  variables:
    MICRO_PATH: "micro_agify"
    DOCKER_IMAGE_NAME: "f64franco/micro-agify"
  trigger:
    include: CI_CD/.main-pipeline.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BRANCH == $MAIN_BRANCH_NAME
      changes:
        - micro_agify/**/*

micro_agify_feature:
  stage: feature
  variables:
    MICRO_PATH: "micro_agify"
  trigger:
    include: CI_CD/.feature-pipeline.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BEFORE_SHA == "0000000000000000000000000000000000000000"
      when: never
    - if: $CI_COMMIT_BRANCH =~ /^(?i)(feature|feat)(.*)/
      changes:
        - micro_agify/**/*
    - when: never

micro_agify_merge_request:
  stage: merge_request
  variables:
    MICRO_PATH: "micro_agify"
  trigger:
    include: CI_CD/.merge-request.yml
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        - micro_agify/**/*

# GENDERIZE
micro_genderize_develop:
  stage: integration
  variables:
    MICRO_PATH: "micro_genderize"
    DOCKER_IMAGE_NAME: "f64franco/micro-genderize"
  trigger:
    include: CI_CD/.develop-pipeline.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BRANCH == $DEVELOP_BRANCH_NAME
      changes:
        - micro_genderize/**/*

micro_genderize_main:
  stage: integration
  variables:
    MICRO_PATH: "micro_genderize"
    DOCKER_IMAGE_NAME: "f64franco/micro-genderize"
  trigger:
    include: CI_CD/.main-pipeline.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BRANCH == $MAIN_BRANCH_NAME
      changes:
        - micro_genderize/**/*

micro_genderize_feature:
  stage: feature
  variables:
    MICRO_PATH: "micro_genderize"
  trigger:
    include: CI_CD/.feature-pipeline.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BEFORE_SHA == "0000000000000000000000000000000000000000"
      when: never
    - if: $CI_COMMIT_BRANCH =~ /^(?i)(feature|feat)(.*)/
      changes:
        - micro_genderize/**/*
    - when: never

micro_genderize_merge_request:
  stage: merge_request
  variables:
    MICRO_PATH: "micro_genderize"
  trigger:
    include: CI_CD/.merge-request.yml
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        - micro_genderize/**/*

# MIDDLEWARE
micro_middleware_develop:
  stage: integration
  variables:
    MICRO_PATH: "middleware"
    DOCKER_IMAGE_NAME: "f64franco/middleware"
  trigger:
    include: CI_CD/.develop-pipeline.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BRANCH == $DEVELOP_BRANCH_NAME
      changes:
        - middleware/**/*

micro_middleware_main:
  stage: integration
  variables:
    MICRO_PATH: "middleware"
    DOCKER_IMAGE_NAME: "f64franco/middleware"
  trigger:
    include: CI_CD/.main-pipeline.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BRANCH == $MAIN_BRANCH_NAME
      changes:
        - middleware/**/*

micro_middleware_feature:
  stage: feature
  variables:
    MICRO_PATH: "middleware"
  trigger:
    include: CI_CD/.feature-pipeline.yml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_COMMIT_BEFORE_SHA == "0000000000000000000000000000000000000000"
      when: never
    - if: $CI_COMMIT_BRANCH =~ /^(?i)(feature|feat)(.*)/
      changes:
        - middleware/**/*
    - when: never

micro_middleware_merge_request:
  stage: merge_request
  variables:
    MICRO_PATH: "middleware"
  trigger:
    include: CI_CD/.merge-request.yml
    strategy: depend
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
      changes:
        - middleware/**/*
